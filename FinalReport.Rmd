---
title: "Final Report: Election Prediction"
author: "Alexander Bendeck, Lynn Fan, Cathy Lee, Alice Liao, Justina Zou"
date: "28 October 2020"
fontsize: 11pt
geometry: "left=1.5cm,right=1.5cm,top=1.5cm,bottom=1.5cm"
output: 
  pdf_document: 
  latex_engine: xelatex
  fig_width: 2
  fig_height: 1
header-includes:
- \usepackage{booktabs}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pkgtest, echo=FALSE}
# source: https://stackoverflow.com/questions/9341635/check-for-installed-packages-before-running-install-packages
pkgTest <- function(x)
  {
    if (!require(x,character.only = TRUE))
    {
      install.packages(x,repos = "http://cran.r-project.org",dep=TRUE)
        if(!require(x,character.only = TRUE)) stop("Package not found")
    }
  }
```

```{r check package,include=FALSE}
pkgTest("gtable") 
pkgTest("ggplot2") 
pkgTest("gridExtra") 
pkgTest("xtable") 
pkgTest("coda") 
pkgTest("dplyr")
pkgTest("reshape2")
pkgTest("readr")
pkgTest("grid")
pkgTest("bayesplot")
pkgTest("knitr")
pkgTest("tidyverse")
pkgTest("stringr")
pkgTest("stringi")
pkgTest("ggplotify")
pkgTest("tidybayes") # easy residuals
```

```{r packages, include=FALSE, message = F}
library(gtable)
library(ggplot2)
library(gridExtra)
library(rjags)
library(R2jags)
library(grid)
library(xtable)
library(coda)
library(bayesplot)
library(rstanarm)
library(dplyr)
library(reshape2)
library(knitr)
library(tidyverse)
library(stringr)
library(stringi)
library(ggplotify)
library(brms)
library(tidybayes) # easy residuals
library(usmap)
#library(xtable)
```

## Introduction

## Data Description

In literature, election prediction relies on polling data as well as "the fundamentals", which are economic and demographic data (The Economist, 2020) *cite in Reference*. To forecast the outcomes of presidential election, senate election and house election (for North Carolina only), we obtained 2020 presidential polling data from *The Economist*, 2020 senate and house polling data as well as partisan lean data from *FiveThirtyEight*. 

The fundamentals data were retrieved from various online sources, such as Adrew Gelman's presidential election prediction model opensource (for correlation across states and historical incumbent party's June approval rating), Federal Reserve Economic Data (for second quarter real income growth), and NC Board of Elections website (for 2020 NC registered voter demographics). Please refer to Appendix B for a detailed description of all data sets used. 

*Appendix B stuff*

### Presidential Election Model: 
- `2020 US presidential election polls - all_polls.csv`: 2020 U.S. Presidential Election Polls compiled by *The Economist*, publiclly available at https://projects.economist.com/us-2020-forecast/president/how-this-works. 
- `partisan_leans_538.csv`: effect of partisan lean on the Democratic candidate's presidential election vote share in each state. Available at https://github.com/fivethirtyeight/data/tree/master/partisan-lean.
- `abramowitz_data.csv`: downloaded from Andrew Gelman's Github repository on 2020 Presidential Election. This data set contains information on each 1948-2016 election year's 2nd quarter GDP performance, incumbent party's June approval rating and incumbent party's vote share. Available at https://github.com/TheEconomist/us-potus-model.
- `states_cov_matrix_full.csv`: covariance matrix of states which take into account similarity between states based on their demographic and political profiles. Retrieved from Andrew Gelman's Github repository on 2020 Presidential Election. 
- `abramowitz_additional.csv`: Supplemented `abramowitz_data.csv` with the corresponding year's 2nd quarter real income growth, 3rd quarter real income growth (data from *FRED* https://fred.stlouisfed.org/series/A067RO1Q156NBEA) and S&P stock performance 3 months prior to the election (data from https://www.multpl.com/s-p-500-historical-prices/table/by-month). 

### Senate Election Model: 
- `senate_polls.csv`: *this is from course website* https://data.fivethirtyeight.com/ ?
- `partisan_leans_538.csv`: same as the data set in presidential election model
- We also incroporated incumbency advantage in the model, which as *FiveThirtyEight* suggests, is on average 2.6 for senate incumbents (https://fivethirtyeight.com/features/how-much-was-incumbency-worth-in-2018/).

### House Election Model (for North Carolina):
- `house_polls.csv`: *this is from course website* https://data.fivethirtyeight.com/ ?
- `ncvoter_1027_small.rds`: NC registered voter demographics information provided by the NC State Board of Elections (https://dl.ncsbe.gov/list.html). 


## Exploratory Data Analysis

```{r load data}
pres_eda_df = readRDS("cleaned_pres_polls.rds")
econ_eda_df = readRDS("cleaned_econ_polls.rds")
econ_state_df = econ_eda_df %>%
  group_by(state) %>%
  summarise(n=n(),avg=mean(y))
house_eda_df = readRDS("cleaned_house_polls.rds")
senate_eda_df = readRDS("cleaned_senate_polls.rds")
senate_state_df = senate_eda_df %>%
  group_by(state) %>%
  summarise(n=n(),avg=mean(y))
```

```{r president EDA}
#number of polls for each state in the economist paper data set
plot_usmap(data = econ_state_df, values = "n", color = "red") + 
  scale_fill_continuous(name = "Number of Polls", label = scales::comma) + 
  theme(legend.position = "right")
#democrat percentage in polling data
ggplot(econ_eda_df, aes(days_to_election, y)) + geom_bin2d()
#democrat percentage by states
plot_usmap(data = econ_state_df, values = "avg", color = "black") + 
  scale_fill_continuous(low = "red", high = "white",name = "Average Democrat Vote Share", label = scales::comma) + 
  theme(legend.position = "right")
```

```{r senate EDA}
#number of polls for senate
plot_usmap(data = senate_state_df, values = "n", color = "red") + 
  scale_fill_continuous(name = "Number of Polls", label = scales::comma) + 
  theme(legend.position = "right")
#biden percentage in polling data
ggplot(senate_eda_df, aes(days_to_election, y)) + geom_bin2d()
#democrat percentage by states
plot_usmap(data = senate_state_df, values = "avg", color = "black") + 
  scale_fill_continuous(low = "red", high = "white",name = "Average Democrat Vote Share", label = scales::comma) + 
  theme(legend.position = "right")
```

```{r house EDA}
#biden percentage in polling data
ggplot(house_eda_df, aes(x=days_to_election, y=y,color=as.factor(seat_number))) + geom_point()
```

## Methods

### Presidential Election Model

The response we will use is $Y_k$, Biden's share of the two-party vote using the following model where the poll $k$ (of $K$=*3361* polls) ended $t$ days (of $T=60$ days) before the election and was conducted on state $j$ (of $J$=14 states of interest). 

$Y_k \sim N(\theta_{jt},\sigma^2_{yj})$ \newline
Priors for $\theta_{jt}$: 
$\theta_{\cdots t} \sim MVN(\theta_{\cdots t-1},\Sigma)$ \newline
$\Sigma \sim Wishart(S, J+1)$ where $S$ is the state covariance matrix (obtained from Andrew Gelman's model) and $J$ is the number of states in the model. \newline
$\sigma^2_{yj} \sim InvGamma(\nu_u, \nu_y\tau_y)$ \newline
$\nu_y \sim Uniform(0,100)$ and $\tau_y \sim Uniform(0,100)$. \newline
$\theta_{j1} \sim N(\mu_{j}, \sigma^2)$  \newline
$\sigma^2 \sim InvGamma(0.5, 0.5)$ \newline
$\mu_{j} \sim N(h_j,7.5^2)$  \newline
$h_j = 0.1*\hat{\text{Presidental Fundamentals}_{2020}} + 0.9*\text{Vote Share from Partisan Lean}_j$  \newline
$\text{Presidental Fundamentals}_i = \gamma_0 + \gamma_1\text{June Approval Ratings for Incumbent Party}_i + \gamma_2\text{Three Month Stock Growth}_i  + \gamma_3\text{2nd Quarter Real Income Growth}_i +\epsilon_i$  \newline
$\epsilon_i \sim N(0, \phi^2)$  \newline

*where explain variables later the S&P stock growth three months prior to the election*
*also explain i where i is each year in that Abramowitz data - kinda explained this in Appendix B*.
In essence, the presidential model used fundamentals and vote share from partisan lean as a starting point for the expected vote share for the Democratic party, and update the priors with presidential election polling data. We predicted $\text{Presidental Fundamentals}_i$ from a linear regression model that used historical election year's economic data and June approval rating of the incumbent party. When computing the 10% weight is allocated to the fundamentals based on economic data and 90% weight to partisan lean because the effect of economic indicators has shrunk over the years as electorates became increasingly polarized (The Economist, 2020). 

*explain how partisan lean was calculated from 538 and how it was turned into Vote Share from Partisan lean*


### Senate Election Model

The response we will use is $Y_k$, the Democrat candidate's share of the two-party vote using the following model where the poll $k$ (of $K$=*fill in* polls) ended $t$ days (of $T=60$ days) before the election and was conducted on state $j$ (of $J$=14 states of interest). 

$Y_k \sim N(\beta_{jt},\sigma^2_{yj})$ \newline
$\beta_{jt} \sim N(\beta_{jt-1},\sigma^2_{\beta j})$ \newline
$\sigma^2_{yj} \sim InvGamma(\nu_u, \nu_y\tau_y)$ \newline
$\nu_y \sim Uniform(0,100)$ and $\tau_y \sim Uniform(0,100)$. \newline
$\sigma^2_{\beta j} \sim InvGamma(\nu_{\beta}, \nu_{\beta}\tau_{\beta}))$ \newline
$\nu_{\beta} \sim Uniform(0,100)$ and $\tau_{\beta} \sim Uniform(0,100)$. \newline
$\beta_{j1} \sim N(\mu_{j}, \sigma^2)$  \newline
$\sigma^2 \sim InvGamma(0.5,0.5)$ \newline
$\mu_{j} \sim N(h_j,7.5^2)$  \newline
$h_j = \text{Vote Share from Partisan Lean}_j + \text{Incumbency Advantage}_j$  \newline

We took the predicted Democratic vote share for North Carolina to predict the outcome of the NC Senate election. *we incorporate voter turnout in the prior, see appendix A.2 - Cathy*

### House Election Model

The response we will use is $Y_k$, the Democrat candidate's share of the two-party vote using the following model where the poll $k$ (of $K$=*fill in* polls) ended $t$ days (of $T=60$ days) before the election and was conducted on district $j$ (where $j$ is in districts $1, \cdots, 11, 13$ of North Carolina). For district 12, the vote share is coded as 100 because there is only one candidate, and she is a Democrat.

$Y_k \sim N(\beta_{jt},\sigma^2_{yj})$ \newline
$\beta_{jt} \sim N(\beta_{jt-1},\sigma^2_{\beta j})$ \newline
$\sigma^2_{yj} \sim InvGamma(\nu_u, \nu_y\tau_y)$ \newline
$\nu_y \sim Uniform(0,100)$ and $\tau_y \sim Uniform(0,100)$. \newline
$\sigma^2_{\beta j} \sim InvGamma(\nu_{\beta}, \nu_{\beta}\tau_{\beta}))$ \newline
$\nu_{\beta} \sim Uniform(0,100)$ and $\tau_{\beta} \sim Uniform(0,100)$. \newline
$\beta_{j1} \sim N(h_j, 7.5)$  \newline
$h_j = 0.9*\text{Vote Share from Partisan Lean}_j + 0.1*\text{Expected Vote Share from Voter Turnout}_j$  \newline

$\text{Expected Vote Share from Voter Turnout}_j$ was calculated from the model in the Interim Report *insert citation whatever that ends up being and also say something like our method for splitting undecided voters is in appendix A.3*. Please see Appendix A.3 for more details. 

*explain how partisan lean was calculated from 538 and how it was turned into Vote Share from Partisan lean*


## Results

## Model Validation and Sensitivity Checks

## Diagnostics

# Appendix A

## A.1 Presidential Election Model

## A.2 Senate Election Model

## A.3 House Election Model

*insert interim report model here*

We fit the voter turnout model from the Interim Report on the 2020 registered voter dataset. The predicted values were the number of people that will vote for each demographic subgroup in each congressional district. We made a reasonable assumption that if someone is registered as a Democrat, that they will indeed vote for the Democratic candidate (and made the same assumption for registered Republicans). If the demographic subgroup had third/unaffiliated party, then we split their predicted number of voters evenly between the Democrat and Republican parties. From this, we calculated Democratic party vote share for each district by taking the ratio of the predicted number of Democratic voters to total number of registered voters in that district.

# Appendix B

# Appendix C (plots and other miscellaneous output)

## References
1. Linzer, D. A. (2013). Dynamic Bayesian Forecasting of Presidential Elections in the States. Journal of the American Statistical Association, 108(501), 124-134. doi:10.1080/01621459.2012.737735
\newline
2. Hansford, T. G., &amp; Gomez, B. T. (2010). Estimating the Electoral Effects of Voter Turnout. American Political Science Review, 104(2), 268-288. doi:10.1017/s0003055410000109
\newline
3. 2020 Election. (2020, October 20). Retrieved October 20, 2020, from https://fivethirtyeight.com/politics/elections/
\newline
4. Park, D. K., Gelman, A., &amp; Bafumi, J. (2006). State-Level Opinions from National Surveys:. Public Opinion in State Politics, 209-228. doi:10.2307/j.ctvr33bdg.17
\newline
5. Mahler, V. A., Jesuit, D. K., &amp; Paradowski, P. R. (2013). Electoral Turnout and State Redistribution. Political Research Quarterly, 67(2), 361-373. doi:10.1177/1065912913509306
\newline
6. Uhlaner, C. J., &amp; Scola, B. (2015). Collective Representation as a Mobilizer. State Politics &amp; Policy Quarterly, 16(2), 227-263. doi:10.1177/1532440015603576
\newline
7. Godbout, J. (2012). Turnout and presidential coattails in congressional elections. Public Choice, 157(1-2), 333-356. doi:10.1007/s11127-012-9947-7
\newline
8. Kim, S. S., Alvarez, R. M., &amp; Ramirez, C. M. (2020). Who Voted in 2016? Using Fuzzy Forests to Understand Voter Turnout. doi:10.33774/apsa-2020-xzx29
\newline
9. Weinschenk, A. C. (2019) That’s Why the Lady Lost to the Trump: Demographics and the 2016 Presidential Election, Journal of Political Marketing, 18:1-2, 69-91, DOI: 10.1080/15377857.2018.1478657
\newline
10. Charles, K. K., &amp; Stephens, M. (2011). Employment, Wages and Voter Turnout. doi:10.3386/w17270
\newline
11. Hills, M. (2020, September 25). US election 2020: A really simple guide. Retrieved October 20, 2020, from https://www.bbc.com/news/election-us-2020-53785985
\newline
12. Railey, K. (2016). Federal Judges Let Stand North Carolina,'s New Congressional Map. The Hotline. https://link.gale.com/apps/doc/A498010836/ITOF?u=duke_perkins&sid=ITOF&xid=119d6ad9
\newline
13. Perrin, A. J., &amp; Ifatunji, M. A. (2020). Race, Immigration, and Support for Donald Trump: Evidence From the 2018 North Carolina Election. Sociological Forum, 35(S1), 941-953. doi:10.1111/socf.12600
\newline
14. Redistricting in North Carolina. (2020). Retrieved October 21, 2020, from https://ballotpedia.org/Redistricting_in_North_Carolina
\newline
15. Â§ 132-1. Public Records.
https://www.ncleg.gov/EnactedLegislation/Statutes/PDF/BySection/Chapter_132/GS_132-1.pdf
\newline
16. Â§ 163-82.10.  Official record of voter registration.
https://www.ncleg.gov/EnactedLegislation/Statutes/PDF/BySection/Chapter_163/GS_163-82.10.pdf
\newline
17. FairVote.org. (n.d.). Voter Turnout. Retrieved October 22, 2020, from https://www.fairvote.org/voter_turnout
\newline
18. McDonald, M. P. (2020). Voter Turnout Demographics. Retrieved October 23, 2020, from http://www.electproject.org/home/voter-turnout/demographics
\newline
19. Y. Ghitza, A. Gelman’s (2013). Deep interactions with MRP: Election Turnout and Voting Patterns Among Small Electoral Subgroups. American Journal of Political Science 57 762– 776.
\newline
20. Walker, H.L., Herron, M.C. & Smith, D.A. Early Voting Changes and Voter Turnout: North Carolina in the 2016 General Election. Polit Behav 41, 841–869 (2019). https://doi-org.proxy.lib.duke.edu/10.1007/s11109-018-9473-5 
\newline
21. Pew Research Center (2020). Men and women in the U.S. continue to differ in voter turnout rate, party identification. https://www.pewresearch.org/fact-tank/2020/08/18/men-and-women-in-the-u-s-continue-to-differ-in-voter-turnout-rate-party-identification/ 
\newline
22. Pew Research Center (2016). Party affiliation among voters: 1992-2016.
https://www.pewresearch.org/politics/2016/09/13/2-party-affiliation-among-voters-1992-2016/ 
\newline
23. J. Misra (2019). Voter Turnout Rates Among All Voting Age and Major Racial and Ethnic Groups Were Higher Than in 2014. https://www.pewresearch.org/fact-tank/2020/08/18/men-and-women-in-the-u-s-continue-to-differ-in-voter-turnout-rate-party-identification/
\newline
24. Killian, L. (2012). Five Myths About Independent Voters. Retrieved October 22, 2020, from https://www.washingtonpost.com/opinions/five-myths-about-independent-voters/2012/05/17/gIQAZmGyWU_story.html
\newline
25. Igielnik, R. (2020). Men and Women in the U.S. Continue to Differ in Voter Turnout Rate. Retrieved October 22, 2020, from https://www.pewresearch.org/fact-tank/2020/08/18/men-and-women-in-the-u-s-continue-to-differ-in-voter-turnout-rate-party-identification/
\newline
26. Akee, R. (2019). Voting and Income. Retrieved October 22, 2020, from https://econofact.org/voting-and-income



