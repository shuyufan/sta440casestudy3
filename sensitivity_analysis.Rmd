---
title: "sensitivity_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(brms)
```


## Load Dataset and Make Groups

```{r}
voter_hist_districts_resp = readRDS("filtered_ncvoterhis_resp.rds")
```

```{r}
q25 = quantile(voter_hist_districts_resp$med_household_income, 0.25)
q50 = quantile(voter_hist_districts_resp$med_household_income, 0.50)
q75 = quantile(voter_hist_districts_resp$med_household_income, 0.75)

# first we need to bin age
voter_hist_districts_resp = voter_hist_districts_resp %>%
  mutate(age_2016 = birth_age - 4) %>%
  filter(!(age_2016 < 18)) %>%
  mutate(age_binned = case_when(
    age_2016 <= 29 ~ "18-29",
    age_2016 >= 30 & age_2016 <= 44 ~ "30-44",
    age_2016 >= 45 & age_2016 <= 59 ~ "45-59",
    age_2016 >= 60 ~ "60+"
  )) %>%
  mutate(med_inc_binned = case_when(
    med_household_income <=q25 ~ paste("<", q25),
    med_household_income > q25 & med_household_income <= q50 ~ paste(q25, "_", q50),
    med_household_income > q50 & med_household_income <= q75 ~ paste(q50, "_", q75),
    med_household_income > q75 ~ paste(">", q75)
  ))

voter_grouped = voter_hist_districts_resp %>%
  group_by(age_binned, gender_code, party_cd, race_code, med_inc_binned) %>%
  summarise(n = n(), votes = sum(vote_or_not))

voter_grouped %>%
  arrange(., n)
```


## Main brms Model (grouped, no random effects)

The main model uses default priors: (flat) prior for the coefficients and a student_t with mean=0, sigma=2.5, df=3 for the intercept

```{r}
binary_model <-
  brm(data = voter_grouped, family = binomial,
      votes | trials(n) ~ 1 + med_inc_binned + gender_code + race_code + age_binned + party_cd + gender_code:party_cd + race_code:party_cd + gender_code:age_binned + party_cd:age_binned,
      iter = 2500, warmup = 500, cores = 2, chains = 2,
      seed = 10)
summary(binary_model, waic=TRUE)
```

```{r warning=FALSE}
binary_model_waic = waic(binary_model)$waic
binary_model_waic
#saveRDS(binary_model, "grouped_model_no_randeff_whole_dataset.rds")
```

Not significant: gender_codeU:party_cdOther, age_binned45M59:party_cdOther


## Different-prior brms Model (grouped, no random effects)

- Older voters tend to vote more often
- Men tend to vote less often than women (not sure about Unspecified)
- People who are not Republicans or Democrats tend to turn out less often, perhaps because they are less satisfied with the candidates
- Wealthier people tend to turn out more often
- For all other terms (including interactions and intercept), centered priors around 0

```{r}
priors <- c(set_prior("normal(0,3)", class = "Intercept"),
            set_prior("normal(0,3)", class = "b"),
            set_prior("normal(0.5,3)", class = "b", coef = "age_binned30M44"),
            set_prior("normal(0.75,3)", class = "b", coef = "age_binned45M59"),
            set_prior("normal(1,3)", class = "b", coef = "age_binned60P"),
            set_prior("normal(-0.5,3)", class = "b", coef = "gender_codeM" ),
            set_prior("normal(-0.5,3)", class = "b", coef = "race_codeBlack" ),
            set_prior("normal(-1,3)", class = "b", coef = "race_codeOther" ),
            set_prior("normal(-0.5,3)", class = "b", coef = "party_cdOther" ),
            set_prior("normal(0.5,3)", class = "b", coef = "med_inc_binned46864_52798" ),
            set_prior("normal(0.5,3)", class = "b", coef = "med_inc_binned52798_64509" ),
            set_prior("normal(1,3)", class = "b", coef = "med_inc_binned>64509" ))


binary_model_newpriors <-
  brm(data = voter_grouped, family = binomial,
      votes | trials(n) ~ 1 + med_inc_binned + gender_code + race_code + age_binned + party_cd + gender_code:party_cd + race_code:party_cd + gender_code:age_binned + party_cd:age_binned,
      iter = 2500, warmup = 500, cores = 2, chains = 2,
      seed = 10,
      prior=priors)
#summary(binary_model_newpriors)
#prior_summary(binary_model_newpriors)
#saveRDS(binary_model_newpriors, "grouped_model_no_randeff_newpriors_whole_dataset.rds")
```

Results: Almost indistinguishable from main model

Not significant: gender_codeU:party_cdOther, age_binned45M59:party_cdOther (same as main model)


### Brms Model With Random Effects

```{r}
randeff_model = readRDS("randeff_sa_grouped_model_whole_data_output.rds")
summary(randeff_model)
```

```{r warning=FALSE}
randeff_model_waic = waic(randeff_model)$waic
randeff_model_waic
#saveRDS(binary_model, "grouped_model_no_randeff_whole_dataset.rds")
```

Results: Extremely similar to main model. Coefficients are smaller for median income, perhaps because some of the variation between different income groups can actually be attributed to differences between counties. However, this difference is not very large. Other coefficients have minimal differences.

Not significant: gender_codeU:party_cdOther, age_binned45M59:party_cdOther (same as main model)


## Frequentist Model (same as main model but not Bayesian)

```{r}
freq_model = glm(cbind(votes, n-votes) ~ med_inc_binned + gender_code + race_code + age_binned + party_cd + gender_code:party_cd + race_code:party_cd + gender_code:age_binned + party_cd:age_binned, data=voter_grouped, family="binomial")
summary(freq_model)
confint(freq_model)
```

Again, extremely similar results to main model.

Not significant: gender_codeU:party_cdOther, age_binned45M59:party_cdOther (same as main model)

